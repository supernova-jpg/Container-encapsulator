# 专业级码流封装及处理工具开发需求 (Pro Muxer)

## 1. 项目名称

专业级码流封装及处理工具 (Pro Muxer)

## 2. 项目概述

开发一款功能强大的专业级桌面应用程序，用于对视频码流文件进行**批量封装（Muxing/Remuxing）**。软件需提供现代化、高效率的图形用户界面（GUI），核心能力是处理**文件夹内的所有文件**，将输入的裸码流（.bin, .h264, .h265等）或已封装的媒体文件（.mp4, .mkv等）快速、无损地重新封装到用户指定的目标容器格式中。

该工具的核心亮点在于其**自动化**和**兼容性**。它必须能够**自动分析**输入文件的媒体信息（如编码格式、分辨率、帧率等），并支持市面上几乎所有主流的音视频编码格式。

该项目应使用 **Qt** 框架构建跨平台的GUI，并深度集成 **FFmpeg**（推荐使用其`libavformat`, `libavcodec`等库，而非仅命令行）以实现强大、高效的后端处理能力。

## 3. 核心功能需求

### 3.1. 用户界面 (UI/UX) - 批量处理优先

- **主界面模式**:
    - **批量处理模式**: 此为默认和核心模式。界面应以一个文件列表（`QTableView`或`QListView`）为中心。
    - **单文件模式**: （可选，或作为简易模式）提供一个简洁的拖放区域处理单个文件。

- **文件操作区**:
    - **添加文件/文件夹**:
        - "添加文件"按钮：支持多选。
        - "添加文件夹"按钮：递归扫描并添加文件夹内所有支持的媒体文件。
        - 支持**拖放**文件和文件夹到文件列表。
    - **文件列表**:
        - **列信息**: 应清晰展示每个文件的 `文件名`, `状态 (等待/处理中/完成/失败)`, `进度`, `检测到的信息 (视频编码, 分辨率, 帧率, 音频编码等)`。
        - **管理功能**: 提供 "移除选中" 和 "清空列表" 的功能。

- **全局配置区**:
    - **输出文件夹**: 用户必须可以指定一个统一的输出目录。
    - **输出容器格式**: 提供一个全局下拉菜单，选项包括 `MP4`, `MKV`, `MOV`, `WebM`, `TS` 等。
    - **命名规则**: 提供简单的输出文件命名规则，如 `原文件名_muxed` 或自定义前后缀。
    - **冲突处理**: 当输出文件已存在时，提供选项：“覆盖”、“跳过”或“自动重命名”。

- **状态与反馈**:
    - **总进度条**: 显示整个批量任务的总体进度。
    - **详细日志窗口**: 实时输出FFmpeg的处理日志，包括当前处理的文件名、警告和错误信息。日志应可分级别查看（Info, Warning, Error）。

### 3.2. 核心处理逻辑

#### 3.2.1. 智能媒体分析 (核心难点)

- **自动检测**: 在文件被添加到列表时，程序必须**立即在后台**使用`ffprobe`或`libavformat`的API对每个文件进行分析。
- **信息提取**:
    - 对于**标准容器文件**（如.mp4, .mkv）：必须能准确解析出视频流、音频流、字幕流的详细信息（编码格式、分辨率、帧率、时长、比特率、色彩空间等）。
    - 对于**裸码流文件**（如.bin, .h264）：
        - **必须提供一个机制让用户手动指定或修正编码格式**，因为裸码流本身不包含元数据，无法100%自动识别。UI上可以在文件列表的“编码格式”列上提供一个下拉菜单进行修改。这里就要体现你作为产品经理UI交互的基本功了。
        - **分辨率/帧率解析**: 程序应尝试从裸码流的SPS/PPS等信息单元中解析分辨率和位深。如果无法解析，应允许用户手动输入这些关键参数，以确保封装的正确性。

#### 3.2.2. 全面的编解码协议支持

- 工具的底层必须能处理FFmpeg所支持的**所有主流音视频编码格式**。封装过程应严格遵循流复制（stream copy）模式 (`-c copy`)。
- **视频编码格式 (Video Codecs)**:
    - `H.264 / AVC`
    - `H.265 / HEVC`
    - `AV1`
    - `VP9`, `VP8`
    - `MPEG-2`
    - `ProRes`, `DNxHD` (专业格式)
    - ...以及其他所有FFmpeg支持的格式。

#### 3.2.3. 智能封装与Corner Case处理

- **容器兼容性判断**: 程序应内置一个兼容性规则库。例如：
    - 当输入为`VP9`或`AV1`时，应默认推荐`MKV`或`WebM`作为输出容器。
- **多轨道处理**: 如果输入文件包含多个视频、音频或字幕轨道，程序应默认将所有轨道全部封装进输出文件。

#### 3.2.4. 稳健的批量处理引擎

- **任务队列**: 使用一个任务队列来管理待处理的文件。
- **多线程架构**:
    - **UI线程**: 保持界面流畅响应。
    - **分析线程**: 专门用于在后台分析拖入的文件。
    - **工作线程**: 执行FFmpeg封装任务。可以设计为支持多个工作线程并行处理（例如，同时处理2-4个文件，可由用户设置）。
- **错误恢复**: 单个文件处理失败（如文件损坏、格式不兼容）不应中断整个批量任务。应在日志中记录错误，并自动开始处理下一个文件。

## 4. 技术实现方案建议

### 4.1. Qt与FFmpeg的集成方式

- **首选方案：API调用**: 强烈建议直接集成FFmpeg的`libavformat`, `libavcodec`, `libavutil`等库。
    - **原因**: 这种方式对媒体信息的获取、处理过程的精细控制（如逐帧读写、进度回调）以及性能都远优于命令行。特别是在需要从裸流中解析SPS/PPS来获取分辨率等高级功能时，API调用是必需的。
    - **挑战**: 编译和部署FFmpeg库相对复杂，需要处理好不同平台下的依赖关系。

- **备选方案：混合调用**:
    - 使用`QProcess`调用`ffprobe -v quiet -print_format json -show_format -show_streams`来快速、准确地分析媒体文件，解析其JSON输出。
    - 使用`QProcess`调用`ffmpeg`命令行执行实际的封装任务。
    - **优点**: 开发速度快，逻辑解耦。
    - **缺点**: 性能略低，对裸流的深度分析能力有限，且分发时需携带`ffmpeg`和`ffprobe`两个可执行文件。

### 4.2. 项目架构

- **Model-View-Controller (MVC)**: 采用MVC或类似的设计模式，将数据模型（文件列表、任务队列）、视图（UI界面）和控制器（业务逻辑）分离。
- **多线程**: 核心功能如文件分析和处理必须在`QThread`的子类中实现，通过信号与槽（Signal/Slot）机制与主UI线程安全通信，更新进度条和日志。

## 5. 预期交付成果
1.  **项目源代码**: 结构清晰、注释良好的C++/Qt项目代码。
3.  **依赖库**: 包含项目所需的所有动态链接库（如FFmpeg的.dll或.so文件）,直接给我下载链接并尝试下载。
4.  **详细文档**:
    - **README.md**: 项目介绍、编译指南和使用说明。
    - **开发者文档**: 简要介绍代码架构和核心模块的功能。
